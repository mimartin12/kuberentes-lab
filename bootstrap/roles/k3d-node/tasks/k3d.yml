---
# Install k3d (idempotent)
# - set `k3d_tag` to e.g. "v5.0.0" to pin a version, or leave empty for latest

- name: Detect controller architecture (for binary name)
  set_fact:
    k3d_arch: "amd64"
  when: ansible_architecture in ['x86_64', 'amd64']

- name: Detect arm64 architecture
  set_fact:
    k3d_arch: "arm64"
  when: ansible_architecture in ['aarch64', 'arm64']

- name: Default to amd64 if arch undetected
  set_fact:
    k3d_arch: "amd64"
  when: k3d_arch is not defined

- name: Ensure /usr/local/bin exists
  file:
    path: /usr/local/bin
    state: directory
    mode: '0755'
  become: true

- name: Check existing k3d binary
  command: /usr/local/bin/k3d --version
  register: k3d_check
  failed_when: false
  changed_when: false

- name: Decide download URL
  set_fact:
    k3d_download_url: >-
      {% if k3d_tag is defined and k3d_tag | length > 0 %}
        https://github.com/k3d-io/k3d/releases/download/{{ k3d_tag }}/k3d-linux-{{ k3d_arch }}
      {% else %}
        https://github.com/k3d-io/k3d/releases/latest/download/k3d-linux-{{ k3d_arch }}
      {% endif %}

- name: Download k3d to temp file (controller-side download when delegate_to localhost)
  get_url:
    url: "{{ k3d_download_url }}"
    dest: "/tmp/k3d-{{ inventory_hostname }}.bin"
    mode: '0755'
    force: yes
  register: dl_k3d
  become: true

- name: Move k3d into place atomically
  command: mv /tmp/k3d-{{ inventory_hostname }}.bin /usr/local/bin/k3d
  args:
    creates: /usr/local/bin/k3d
  become: true
  when: dl_k3d is changed

- name: Ensure k3d has correct permissions
  file:
    path: /usr/local/bin/k3d
    mode: '0755'
    owner: root
    group: root
  become: true

- name: Verify installed k3d version
  command: /usr/local/bin/k3d --version
  register: installed_k3d
  failed_when: false
  changed_when: false

- name: Fail if a specific k3d_tag was requested but not installed
  fail:
    msg: "Installed k3d version does not match requested tag {{ k3d_tag }} (installed: {{ installed_k3d.stdout }})"
  when:
    - k3d_tag is defined
    - k3d_tag | length > 0
    - k3d_tag not in (installed_k3d.stdout | default(''))

- name: Check if k3d cluster 'lab' already exists
  command: /usr/local/bin/k3d cluster list
  register: k3d_cluster_list
  changed_when: false
  failed_when: false
  become: true

- name: Copy k3d config file to remote
  copy:
    src: k3d-config.yml
    dest: /tmp/k3d-config.yml
    mode: '0644'
  become: true
  when: "'lab' not in k3d_cluster_list.stdout"

- name: Create k3d cluster from config
  command: /usr/local/bin/k3d cluster create --config /tmp/k3d-config.yml
  become: true
  when: "'lab' not in k3d_cluster_list.stdout"

- name: Clean up k3d config file
  file:
    path: /tmp/k3d-config.yml
    state: absent
  become: true

- name: Create home directory for user if it does not exist
  file:
    path: "/home/{{ ansible_user }}/.kube"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: true
  when: "'lab' not in k3d_cluster_list.stdout"

- name: Copy kubeconfig to user's home directory
  copy:
    remote_src: true
    src: /root/.kube/config
    dest: "/home/{{ ansible_user }}/.kube/config"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  become: true
  when: "'lab' not in k3d_cluster_list.stdout"

