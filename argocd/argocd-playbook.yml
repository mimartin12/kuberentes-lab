---
- name: Apply Kustomization with kubectl on the Kubernetes node
  hosts: all
  become: false
  tasks:
    - name: Copy kustomization files to the remote node
      copy:
        src: "{{ playbook_dir }}/"
        dest: /tmp/argocd-kustomize

    - name: Apply kustomization using kubectl
      command: kubectl apply -k /tmp/argocd-kustomize
      register: apply_result
      changed_when: "'configured' in apply_result.stdout or 'created' in apply_result.stdout"

    - name: Apply Argo CD Application
      command: kubectl apply -f /tmp/argocd-kustomize/argocd-application.yaml
      register: argocd_apply_result
      changed_when: "'configured' in argocd_apply_result.stdout or 'created' in argocd_apply_result.stdout"

    - name: Clean up kustomization files from the remote node
      file:
        path: /tmp/argocd-kustomize
        state: absent

    - name: Show apply result
      debug:
        var: apply_result.stdout_lines
